# SubgraphClient

The `SubgraphClient` class provides the main interface for querying The Graph subgraph with type-safe query builders and automatic serialization.

## Factory Methods

### createForNetwork()

Create a client with automatic network configuration:

```typescript
import { SubgraphClient } from '@prepaid-gas/data'

// Base Sepolia
const client = SubgraphClient.createForNetwork(84532)

// Base Mainnet (when available)
const client = SubgraphClient.createForNetwork(8453)
```

### Constructor

Create a client with custom configuration:

```typescript
import { SubgraphClient, type SubgraphClientOptions } from '@prepaid-gas/data'

const options: SubgraphClientOptions = {
  url: 'https://api.thegraph.com/subgraphs/name/your-subgraph',
  network: 'base-sepolia'
}

const client = new SubgraphClient(options)
```

## Core Methods

### query()

Entry point for all query operations:

```typescript
const queryBuilder = client.query()

// Available query types
queryBuilder.pools()         // Query pools
queryBuilder.poolMembers()   // Query pool members  
queryBuilder.transactions()  // Query transactions
queryBuilder.paymasters()    // Query paymaster contracts
queryBuilder.networkInfo()   // Query network information
```

## Configuration Options

### SubgraphClientOptions

```typescript
interface SubgraphClientOptions {
  url: string      // The Graph API endpoint
  network: string  // Network identifier (e.g., 'base-sepolia')
}
```

## Query Entry Points

### Pools Query

Query privacy pools:

```typescript
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .withMembers(50)
  .execute()
```

**Available Methods:**
- `byNetwork(network)` - Filter by network (required)
- `byId(id)` - Get specific pool by ID  
- `byPaymaster(address)` - Filter by paymaster contract
- `withMembers(limit?)` - Include pool members
- `withTransactions(limit?)` - Include pool transactions
- `orderBy(field, direction?)` - Order results
- `first(count)` - Limit result count
- `after(cursor)` - Pagination cursor

### Pool Members Query

Query individual pool members:

```typescript
const members = await client.query()
  .poolMembers()
  .byNetwork('base-sepolia')
  .byPool('1')
  .execute()
```

**Available Methods:**
- `byNetwork(network)` - Filter by network (required)
- `byPool(poolId)` - Filter by pool ID
- `byCommitment(commitment)` - Filter by identity commitment
- `orderBy(field, direction?)` - Order results
- `first(count)` - Limit result count
- `after(cursor)` - Pagination cursor

### Transactions Query

Query user operations processed by paymasters:

```typescript
const transactions = await client.query()
  .transactions()
  .byNetwork('base-sepolia')
  .byPool('1')
  .orderBy('timestamp', 'desc')
  .first(100)
  .execute()
```

**Available Methods:**
- `byNetwork(network)` - Filter by network (required)
- `byPool(poolId)` - Filter by pool ID
- `byHash(hash)` - Get specific transaction
- `byPaymaster(address)` - Filter by paymaster
- `orderBy(field, direction?)` - Order results
- `first(count)` - Limit result count
- `after(cursor)` - Pagination cursor

### Paymasters Query

Query paymaster contracts:

```typescript
const paymasters = await client.query()
  .paymasters()
  .byNetwork('base-sepolia')
  .withPools(20)
  .execute()
```

**Available Methods:**
- `byNetwork(network)` - Filter by network (required)
- `byAddress(address)` - Get specific paymaster
- `withPools(limit?)` - Include pools
- `withTransactions(limit?)` - Include transactions
- `orderBy(field, direction?)` - Order results
- `first(count)` - Limit result count

### Network Info Query

Query network-level information:

```typescript
const networkInfo = await client.query()
  .networkInfo()
  .byNetwork('base-sepolia')
  .execute()
```

## Execution Methods

### execute()

Execute query and return raw entities:

```typescript
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .execute() // Returns Pool[]
```

### executeAndSerialize()

Execute query and return serialized entities safe for JSON:

```typescript
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .executeAndSerialize() // Returns SerializedPool[]
```

**Use Cases:**
- API responses where BigInt values need to be strings
- Client-side storage where JSON serialization is required
- Data transfer between systems

## Filtering and Ordering

### Network Filtering

Always required for accurate multi-chain results:

```typescript
// âœ… Required: Network filtering
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia') // Always specify network
  .execute()
```

### Paymaster Filtering

Filter by specific paymaster contract:

```typescript
const paymasterPools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .byPaymaster('0x1234567890123456789012345678901234567890')
  .execute()
```

### Ordering

Control result ordering:

```typescript
// Order by creation time (newest first)
const newestPools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .orderBy('createdAt', 'desc')
  .execute()

// Order by member count (largest first)  
const largestPools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .orderBy('memberCount', 'desc')
  .execute()
```

## Pagination

### Basic Pagination

```typescript
// First page
const firstPage = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .first(20)
  .execute()

// Next page using cursor
const nextPage = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .after(firstPage[firstPage.length - 1].id)
  .first(20)
  .execute()
```

### Helper Function for Pagination

```typescript
async function getAllPools(client: SubgraphClient, pageSize = 100) {
  const allPools = []
  let cursor: string | undefined
  
  while (true) {
    const query = client.query()
      .pools()
      .byNetwork('base-sepolia')
      .first(pageSize)
    
    if (cursor) {
      query.after(cursor)
    }
    
    const page = await query.execute()
    
    if (page.length === 0) break
    
    allPools.push(...page)
    cursor = page[page.length - 1].id
    
    if (page.length < pageSize) break // Last page
  }
  
  return allPools
}
```

## Relationship Loading

### Configurable Limits

Control how many related entities to load:

```typescript
// Load pools with limited relationships
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .withMembers(50)      // Up to 50 members per pool
  .withTransactions(25) // Up to 25 transactions per pool
  .execute()
```

### Performance Considerations

**Minimal Loading (Fastest)**:
```typescript
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .execute() // No relationships loaded
```

**Selective Loading (Balanced)**:
```typescript
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .withMembers(100) // Only members, no transactions
  .execute()
```

**Full Loading (Comprehensive)**:
```typescript
const pools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .withMembers(200)
  .withTransactions(100)
  .execute() // Full data, slower
```

## Error Handling

### SubgraphError

Handle subgraph-specific errors:

```typescript
import { SubgraphError } from '@prepaid-gas/data'

try {
  const pools = await client.query().pools().execute()
} catch (error) {
  if (error instanceof SubgraphError) {
    console.error('Subgraph query failed:', error.message)
    console.error('GraphQL query:', error.query)
    console.error('Variables:', error.variables)
  }
}
```

### Network Errors

Handle network connectivity issues:

```typescript
try {
  const pools = await client.query().pools().execute()
} catch (error) {
  if (error.message.includes('fetch')) {
    console.error('Network error - check subgraph availability')
  }
}
```

### Validation Errors

Handle query validation failures:

```typescript
try {
  const pools = await client.query()
    .pools()
    .first(2000) // Exceeds maximum limit
    .execute()
} catch (error) {
  console.error('Query validation failed:', error.message)
}
```

## Performance Optimization

### Request Deduplication

Identical queries are automatically deduplicated:

```typescript
// These will result in only one network request
const promise1 = client.query().pools().byNetwork('base-sepolia').execute()
const promise2 = client.query().pools().byNetwork('base-sepolia').execute()

const [pools1, pools2] = await Promise.all([promise1, promise2])
// pools1 and pools2 contain identical data
```

### Query Batching

Batch related queries for efficiency:

```typescript
// Execute multiple queries in parallel
const [pools, transactions, paymasters] = await Promise.all([
  client.query().pools().byNetwork('base-sepolia').execute(),
  client.query().transactions().byNetwork('base-sepolia').first(50).execute(),
  client.query().paymasters().byNetwork('base-sepolia').execute()
])
```

### Selective Field Loading

The Graph optimizes queries by only fetching requested fields. Relationship loading is controlled by the SDK to minimize data transfer.

## Safety Limits

### Built-in Limits

The client enforces safety limits to prevent excessive data fetching:

```typescript
// Default limits
const pools = await client.query()
  .pools()
  .execute() // Maximum 100 results by default

// Custom limits (up to maximum)
const morePools = await client.query()
  .pools() 
  .first(500) // Up to 500 results (max 1000)
  .execute()
```

### Relationship Limits

```typescript
// Relationships also have limits
const pools = await client.query()
  .pools()
  .withMembers(1000)      // Max 1000 members per pool
  .withTransactions(500)  // Max 500 transactions per pool
  .execute()
```

## Examples

### Real-world Query Patterns

**Pool Discovery for Joining**:
```typescript
const availablePools = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .withMembers(100) // Check member counts
  .orderBy('memberCount', 'desc') // Largest pools first
  .first(20)
  .executeAndSerialize()

const largePools = availablePools.filter(pool => pool.memberCount > 50)
```

**Transaction History Analysis**:
```typescript
const recentActivity = await client.query()
  .transactions()
  .byNetwork('base-sepolia')
  .orderBy('timestamp', 'desc')
  .first(100)
  .execute()

const last24Hours = recentActivity.filter(tx => 
  Date.now() - parseInt(tx.timestamp) * 1000 < 24 * 60 * 60 * 1000
)
```

**Pool Health Monitoring**:
```typescript
const poolHealth = await client.query()
  .pools()
  .byNetwork('base-sepolia')
  .withMembers()
  .withTransactions(50)
  .executeAndSerialize()

const healthReport = poolHealth.map(pool => ({
  poolId: pool.poolId,
  memberCount: pool.memberCount,
  recentActivity: pool.transactions?.length || 0,
  isHealthy: pool.memberCount > 10 && (pool.transactions?.length || 0) > 0
}))
```