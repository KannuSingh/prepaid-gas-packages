# Basic Usage Examples

Simple examples to get started with the Prepaid Gas SDK.

## Basic Paymaster Integration

### Simple Transaction

```typescript
import { PrepaidGasPaymaster } from '@prepaid-gas/core'
import { SubgraphClient } from '@prepaid-gas/data'
import { Identity } from '@semaphore-protocol/identity'

async function basicExample() {
  // 1. Create clients
  const paymaster = PrepaidGasPaymaster.createForNetwork(84532)
  const subgraph = SubgraphClient.createForNetwork(84532)
  
  // 2. Create identity
  const identity = new Identity()
  console.log('Identity commitment:', identity.commitment.toString())
  
  // 3. Find available pools
  const pools = await subgraph.query()
    .pools()
    .byNetwork('base-sepolia')
    .withMembers(50)
    .first(10)
    .executeAndSerialize()
  
  console.log('Available pools:', pools.length)
  
  // 4. Select first pool
  const selectedPool = pools[0]
  
  // 5. Create user operation (example)
  const userOp = {
    sender: '0x1234567890123456789012345678901234567890',
    nonce: 0n,
    callData: '0x',
    callGasLimit: 100000n,
    verificationGasLimit: 100000n,
    preVerificationGas: 21000n,
    maxFeePerGas: 1000000000n,
    maxPriorityFeePerGas: 1000000000n,
    signature: '0x'
  }
  
  // 6. Get paymaster data
  const result = await paymaster.getPaymasterData({
    userOp,
    poolId: selectedPool.poolId,
    identity: identity.export()
  })
  
  console.log('Paymaster data generated successfully!')
  console.log('Gas limit:', result.callGasLimit.toString())
  console.log('Is final:', result.isFinal)
  
  return result
}

// Run example
basicExample().catch(console.error)
```

## Gas Estimation

### Fast Gas Estimation

```typescript
async function gasEstimationExample() {
  const paymaster = PrepaidGasPaymaster.createForNetwork(84532)
  
  const userOp = {
    sender: '0x1234567890123456789012345678901234567890',
    nonce: 0n,
    callData: '0x',
    callGasLimit: 100000n,
    verificationGasLimit: 100000n,
    preVerificationGas: 21000n,
    maxFeePerGas: 1000000000n,
    maxPriorityFeePerGas: 1000000000n,
    signature: '0x'
  }
  
  // Fast estimation (no ZK proof)
  const estimate = await paymaster.getPaymasterStubData({
    userOp,
    poolId: '1',
    identity: 'dummy-identity' // Not used for estimation
  })
  
  console.log('Gas estimate:', {
    callGasLimit: estimate.callGasLimit.toString(),
    verificationGasLimit: estimate.verificationGasLimit.toString(),
    paymasterVerificationGasLimit: estimate.paymasterVerificationGasLimit.toString(),
    paymasterPostOpGasLimit: estimate.paymasterPostOpGasLimit.toString(),
    isFinal: estimate.isFinal // false for estimates
  })
  
  return estimate
}
```

## Pool Queries

### Find Optimal Pool

```typescript
async function findBestPool() {
  const subgraph = SubgraphClient.createForNetwork(84532)
  
  // Get pools with member data
  const pools = await subgraph.query()
    .pools()
    .byNetwork('base-sepolia')
    .withMembers(100)
    .orderBy('memberCount', 'desc')
    .first(20)
    .executeAndSerialize()
  
  // Find pools with good anonymity
  const goodPools = pools.filter(pool => pool.memberCount >= 20)
  
  if (goodPools.length === 0) {
    throw new Error('No pools with sufficient anonymity found')
  }
  
  const bestPool = goodPools[0]
  
  console.log('Best pool found:', {
    poolId: bestPool.poolId,
    memberCount: bestPool.memberCount,
    paymasterAddress: bestPool.paymasterAddress
  })
  
  return bestPool
}
```

### Check Pool Membership

```typescript
async function checkPoolMembership(poolId: string, identityCommitment: string) {
  const subgraph = SubgraphClient.createForNetwork(84532)
  
  // Get all members of the pool
  const members = await subgraph.query()
    .poolMembers()
    .byNetwork('base-sepolia')
    .byPool(poolId)
    .execute()
  
  // Check if identity is a member
  const isMember = members.some(member => 
    member.identityCommitment === identityCommitment
  )
  
  console.log(`Identity ${identityCommitment.slice(0, 10)}... is ${isMember ? '' : 'NOT '}a member of pool ${poolId}`)
  console.log(`Pool has ${members.length} total members`)
  
  return { isMember, memberCount: members.length, members }
}
```

## Error Handling

### Basic Error Handling

```typescript
import { ValidationError, PaymasterError } from '@prepaid-gas/core'
import { SubgraphError } from '@prepaid-gas/data'

async function errorHandlingExample() {
  const paymaster = PrepaidGasPaymaster.createForNetwork(84532)
  
  try {
    const result = await paymaster.getPaymasterData({
      userOp: invalidUserOp,
      poolId: 'invalid-pool',
      identity: 'invalid-identity'
    })
  } catch (error) {
    if (error instanceof ValidationError) {
      console.error('Validation failed:', {
        field: error.field,
        message: error.message,
        value: error.value
      })
    } else if (error instanceof PaymasterError) {
      console.error('Paymaster error:', {
        code: error.code,
        message: error.message,
        context: error.context
      })
    } else if (error instanceof SubgraphError) {
      console.error('Subgraph error:', {
        message: error.message,
        query: error.query,
        variables: error.variables
      })
    } else {
      console.error('Unexpected error:', error)
    }
  }
}
```

## Complete Transaction Flow

### End-to-End Example

```typescript
import { createSmartAccountClient } from 'permissionless'
import { http } from 'viem'
import { baseSepolia } from 'viem/chains'

async function completeTransactionFlow() {
  // 1. Setup
  const paymaster = PrepaidGasPaymaster.createForNetwork(84532)
  const subgraph = SubgraphClient.createForNetwork(84532)
  const identity = new Identity()
  
  // 2. Find suitable pool
  const pools = await subgraph.query()
    .pools()
    .byNetwork('base-sepolia')
    .withMembers(50)
    .orderBy('memberCount', 'desc')
    .first(5)
    .executeAndSerialize()
  
  if (pools.length === 0) {
    throw new Error('No pools available')
  }
  
  const selectedPool = pools[0]
  console.log('Selected pool:', selectedPool.poolId, 'with', selectedPool.memberCount, 'members')
  
  // 3. Setup smart account (example configuration)
  const smartAccount = createSmartAccountClient({
    // ... your smart account configuration
    transport: http('https://sepolia.base.org'),
    chain: baseSepolia
  })
  
  // 4. Prepare transaction
  const calls = [{
    to: '0x1234567890123456789012345678901234567890',
    data: '0x',
    value: 1000000000000000n // 0.001 ETH
  }]
  
  // 5. Create user operation
  const userOp = await smartAccount.prepareUserOperation({ calls })
  
  // 6. Get gas estimate first
  const gasEstimate = await paymaster.getPaymasterStubData({
    userOp,
    poolId: selectedPool.poolId,
    identity: identity.export()
  })
  
  console.log('Gas estimate:', gasEstimate.callGasLimit.toString())
  
  // 7. Generate real paymaster data
  console.log('Generating ZK proof...')
  const paymasterData = await paymaster.getPaymasterData({
    userOp,
    poolId: selectedPool.poolId,
    identity: identity.export()
  })
  
  console.log('ZK proof generated successfully!')
  
  // 8. Update user operation with paymaster data
  userOp.paymaster = paymasterData.paymaster
  userOp.paymasterData = paymasterData.paymasterData
  userOp.paymasterVerificationGasLimit = paymasterData.paymasterVerificationGasLimit
  userOp.paymasterPostOpGasLimit = paymasterData.paymasterPostOpGasLimit
  
  // 9. Submit transaction
  console.log('Submitting transaction...')
  const userOpHash = await smartAccount.sendUserOperation(userOp)
  console.log('User operation hash:', userOpHash)
  
  // 10. Wait for confirmation
  const receipt = await smartAccount.waitForUserOperationReceipt({
    hash: userOpHash
  })
  
  console.log('Transaction confirmed!')
  console.log('Transaction hash:', receipt.receipt.transactionHash)
  console.log('Gas used:', receipt.receipt.gasUsed.toString())
  
  return {
    userOpHash,
    transactionHash: receipt.receipt.transactionHash,
    gasUsed: receipt.receipt.gasUsed,
    poolUsed: selectedPool.poolId
  }
}

// Run complete example
completeTransactionFlow()
  .then(result => {
    console.log('Transaction completed successfully:', result)
  })
  .catch(error => {
    console.error('Transaction failed:', error)
  })
```

## Utility Functions

### Helper Functions

```typescript
// Utility functions for common operations

export async function getPoolInfo(poolId: string) {
  const subgraph = SubgraphClient.createForNetwork(84532)
  
  const pools = await subgraph.query()
    .pools()
    .byId(`base-sepolia-${poolId}`)
    .withMembers()
    .withTransactions(10)
    .executeAndSerialize()
  
  if (pools.length === 0) {
    throw new Error(`Pool ${poolId} not found`)
  }
  
  const pool = pools[0]
  
  return {
    poolId: pool.poolId,
    memberCount: pool.memberCount,
    recentTransactions: pool.transactions?.length || 0,
    paymasterAddress: pool.paymasterAddress,
    members: pool.members?.map(m => ({
      commitment: m.identityCommitment,
      joinedAt: m.joinedAt
    })) || []
  }
}

export async function estimateGasCost(userOp: any, poolId: string) {
  const paymaster = PrepaidGasPaymaster.createForNetwork(84532)
  
  const estimate = await paymaster.getPaymasterStubData({
    userOp,
    poolId,
    identity: 'dummy' // Not used for estimation
  })
  
  const totalGas = estimate.callGasLimit + 
                   estimate.verificationGasLimit + 
                   estimate.paymasterVerificationGasLimit + 
                   estimate.paymasterPostOpGasLimit
  
  return {
    callGas: estimate.callGasLimit,
    verificationGas: estimate.verificationGasLimit,
    paymasterGas: estimate.paymasterVerificationGasLimit + estimate.paymasterPostOpGasLimit,
    totalGas,
    estimatedCostWei: totalGas * userOp.maxFeePerGas
  }
}

export function createTestIdentity(): { identity: Identity, commitment: string } {
  const identity = new Identity()
  return {
    identity,
    commitment: identity.commitment.toString()
  }
}
```

## Environment Setup

### Development Environment

```typescript
// dev-setup.ts
export function setupDevelopmentEnvironment() {
  // Check if we're in development
  const isDev = process.env.NODE_ENV === 'development'
  
  if (isDev) {
    // Enable debug logging
    localStorage.setItem('debug', 'prepaid-gas:*')
    
    // Add global helpers for development
    if (typeof window !== 'undefined') {
      window.PrepaidGasSDK = {
        PaymasterClient: PrepaidGasPaymaster,
        SubgraphClient,
        Identity,
        utils: {
          getPoolInfo,
          estimateGasCost,
          createTestIdentity
        }
      }
      
      console.log('Prepaid Gas SDK helpers available at window.PrepaidGasSDK')
    }
  }
}

// Call in your app initialization
setupDevelopmentEnvironment()
```

## Testing Helpers

### Mock Data

```typescript
// test-helpers.ts
export const mockUserOp = {
  sender: '0x1234567890123456789012345678901234567890',
  nonce: 0n,
  callData: '0x',
  callGasLimit: 100000n,
  verificationGasLimit: 100000n,
  preVerificationGas: 21000n,
  maxFeePerGas: 1000000000n,
  maxPriorityFeePerGas: 1000000000n,
  signature: '0x'
}

export const mockPool = {
  id: 'base-sepolia-1',
  poolId: '1',
  memberCount: 25,
  paymasterAddress: '0x1234567890123456789012345678901234567890',
  totalDeposited: '1000000000000000000',
  createdAt: '1640995200',
  updatedAt: '1640995200'
}

export function createMockIdentity(): Identity {
  return new Identity('test-secret')
}
```

These examples provide a solid foundation for integrating the Prepaid Gas SDK into your application. Start with the basic examples and gradually move to more complex use cases as you become familiar with the SDK.