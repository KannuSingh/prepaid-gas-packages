# Query API Reference

Complete reference for the SubgraphClient query builder methods.

## SubgraphClient

### Creating a Client

```typescript
import { SubgraphClient } from '@prepaid-gas/data'

// For Base Sepolia
const client = SubgraphClient.createForNetwork(84532)

// With custom subgraph URL
const client = SubgraphClient.createForNetwork(84532, {
  subgraphUrl: 'https://custom-subgraph.com'
})
```

## Paymaster Queries

### Basic Methods

```typescript
// Start paymaster query
client.query().paymasters()
```

### Filtering Methods

#### byNetwork(network)
```typescript
.byNetwork('base-sepolia')
.byNetwork('base')
```

#### byAddress(address)
```typescript
.byAddress('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
```

#### byContractType(type)
```typescript
.byContractType('OneTimeUse')
.byContractType('GasLimited')
.byContractType('CacheEnabledGasLimited')
```

#### byId(network, address)
```typescript
.byId('base-sepolia', '0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
```

#### withMinMembers(count)
```typescript
.withMinMembers(10) // At least 10 members
```

#### deployedAfter(timestamp)
```typescript
.deployedAfter('1640995200')
.deployedAfter(1640995200)
```

#### deployedBefore(timestamp)
```typescript
.deployedBefore('1640999999')
```

#### onlyAlive()
```typescript
.onlyAlive() // Exclude dead pools
```

### Data Inclusion

#### withActivities()
```typescript
.withActivities() // Include activity timeline
```

### Ordering Methods

#### orderByMembers(direction?)
```typescript
.orderByMembers() // desc by default
.orderByMembers('asc')
```

#### orderByDeployment(direction?)
```typescript
.orderByDeployment() // newest first
.orderByDeployment('asc') // oldest first
```

#### orderByActivity(direction?)
```typescript
.orderByActivity() // most recent activity first
```

### Pagination

#### limit(count)
```typescript
.limit(25) // Max 25 results
```

#### skip(count)  
```typescript
.skip(50) // Skip first 50 results
```

## Activity Queries

### Basic Methods

```typescript
// All activities
client.query().activities()

// Specific activity types
client.query().activities().byType('DEPOSIT')
client.query().activities().byType('USER_OP_SPONSORED')
```

### Filtering Methods

#### byPaymaster(address)
```typescript
.byPaymaster('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
```

#### byType(type)
```typescript
.byType('DEPOSIT')
.byType('USER_OP_SPONSORED')
.byType('REVENUE_WITHDRAWN')
```

#### byCommitment(commitment)
```typescript
.byCommitment('123456789...') // Find deposits by identity
```

#### bySender(address)
```typescript
.bySender('0x1234...') // User operations by sender
```

#### afterTimestamp(timestamp)
```typescript
.afterTimestamp('1640995200')
```

#### beforeTimestamp(timestamp)
```typescript
.beforeTimestamp('1640999999')
```

### Ordering

#### orderByTimestamp(direction?)
```typescript
.orderByTimestamp() // newest first
.orderByTimestamp('asc') // oldest first
```

#### orderByBlock(direction?)
```typescript
.orderByBlock('desc')
```

## Execution Methods

### execute()
Returns raw data with BigInt types:

```typescript
const data = await client.query()
  .paymasters()
  .byNetwork('base-sepolia')
  .execute()

// data contains BigInt values
console.log(typeof data[0].treeSize) // 'bigint'
```

### executeAndSerialize()  
Returns serialized data with string types (for JSON APIs):

```typescript
const data = await client.query()
  .paymasters()
  .byNetwork('base-sepolia')
  .executeAndSerialize()

// data contains string values
console.log(typeof data[0].treeSize) // 'string'
```

## Advanced Usage

### Field Selection

```typescript
const minimal = await client.query()
  .paymasters()
  .select(['id', 'address', 'contractType'])
  .execute()
```

### Complex Queries

```typescript  
const popularOneTimeUse = await client.query()
  .paymasters()
  .byNetwork('base-sepolia')
  .byContractType('OneTimeUse')
  .withMinMembers(5)
  .onlyAlive()
  .orderByMembers('desc')
  .limit(10)
  .withActivities()
  .execute()
```

### Raw GraphQL

For custom queries:

```typescript
const customData = await client.executeQuery(
  'query Custom($network: String!) { paymasterContracts(where: { network: $network }) { id address } }',
  { network: 'base-sepolia' }
)
```

## Common Query Patterns

### Pool Discovery
```typescript
const availablePools = await client.query()
  .paymasters()
  .byNetwork('base-sepolia')
  .onlyAlive()
  .orderByMembers('desc')
  .execute()
```

### Identity Membership Check
```typescript
const userDeposits = await client.query()
  .activities()
  .byType('DEPOSIT')
  .byCommitment(identity.commitment.toString())
  .execute()
```

### Transaction History
```typescript
const userTransactions = await client.query()
  .activities()
  .byType('USER_OP_SPONSORED')
  .bySender(userAddress)
  .orderByTimestamp('desc')
  .limit(50)
  .execute()
```

### Pool Activity Feed
```typescript
const activity = await client.query()
  .activities()
  .byPaymaster(paymasterAddress)
  .orderByTimestamp('desc')
  .limit(100)
  .execute()
```