# Data Package

The `@prepaid-gas/data` package provides a fluent API for querying paymaster and transaction data from The Graph subgraph.

## Installation

```bash
npm install @prepaid-gas/data
```

## Basic Usage

```typescript
import { SubgraphClient } from '@prepaid-gas/data'

// Create client for Base Sepolia
const client = SubgraphClient.createForNetwork(84532)

// Query paymasters
const paymasters = await client.query()
  .paymasters()
  .byNetwork('base-sepolia')
  .byContractType('OneTimeUse')
  .limit(10)
  .execute()
```

## Query Types

### Paymaster Queries

Get paymaster contract information:

```typescript
// All paymasters on network
const all = await client.query()
  .paymasters()
  .byNetwork('base-sepolia')
  .execute()

// Specific paymaster
const paymaster = await client.query()
  .paymasters()
  .byAddress('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
  .execute()

// With activity data
const withActivity = await client.query()
  .paymasters()
  .byAddress('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
  .withActivities()
  .execute()
```

### Activity Queries

Get transaction and deposit history:

```typescript
// All activities for a paymaster
const activities = await client.query()
  .activities()
  .byPaymaster('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
  .orderByTimestamp('desc')
  .limit(50)
  .execute()

// Only deposits (for membership proofs)
const deposits = await client.query()
  .activities()
  .byType('DEPOSIT')
  .byPaymaster('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
  .execute()

// Only user operations
const userOps = await client.query()
  .activities()
  .byType('USER_OP_SPONSORED')
  .byPaymaster('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
  .execute()
```

## Filtering Methods

### By Network
```typescript
const data = await client.query()
  .paymasters()
  .byNetwork('base-sepolia') // or 'base'
  .execute()
```

### By Contract Type
```typescript
const oneTimeUse = await client.query()
  .paymasters()
  .byContractType('OneTimeUse')
  .execute()

const gasLimited = await client.query()
  .paymasters()
  .byContractType('GasLimited')
  .execute()
```

### By Member Count
```typescript
const popular = await client.query()
  .paymasters()
  .withMinMembers(10)
  .execute()
```

### By Time Range
```typescript
const recent = await client.query()
  .activities()
  .afterTimestamp('1640995200')
  .beforeTimestamp('1640999999')
  .execute()
```

## Ordering and Pagination

### Ordering
```typescript
// By member count
const byMembers = await client.query()
  .paymasters()
  .orderByMembers('desc')
  .execute()

// By deployment date
const newest = await client.query()
  .paymasters()
  .orderByDeployment('desc')
  .execute()

// By activity timestamp
const recentActivity = await client.query()
  .activities()
  .orderByTimestamp('desc')
  .execute()
```

### Pagination
```typescript
const page1 = await client.query()
  .paymasters()
  .limit(25)
  .skip(0)
  .execute()

const page2 = await client.query()
  .paymasters()
  .limit(25)
  .skip(25)
  .execute()
```

## Data Types

### PaymasterContract
```typescript
interface PaymasterContract {
  id: string                    // "network-address"
  contractType: string          // "OneTimeUse" | "GasLimited" | "CacheEnabledGasLimited"
  address: string               // Contract address
  network: string               // "base-sepolia"
  chainId: bigint               // 84532
  
  joiningAmount: bigint         // Amount required to join
  treeSize: bigint              // Number of members
  
  activities?: Activity[]       // When using withActivities()
}
```

### Activity
```typescript
interface Activity {
  id: string
  type: 'DEPOSIT' | 'USER_OP_SPONSORED' | 'REVENUE_WITHDRAWN'
  timestamp: bigint
  block: bigint
  transaction: string
  
  // Deposit fields (when type = 'DEPOSIT')
  depositor?: string            // Who joined
  commitment?: bigint           // Identity commitment
  
  // User operation fields (when type = 'USER_OP_SPONSORED')
  sender?: string               // Transaction sender
  userOpHash?: string           // Operation hash
  actualGasCost?: bigint        // Gas cost
}
```

## Common Patterns

### Finding Pools for Identity

```typescript
// Find where an identity has deposited
const deposits = await client.query()
  .activities()
  .byType('DEPOSIT')
  .byCommitment('123456789...')
  .execute()

// Get unique paymaster addresses
const paymasterAddresses = [...new Set(
  deposits.map(d => d.paymaster.address)
)]
```

### Getting Members for Proof Generation

```typescript
// Get all deposits for a paymaster (for ZK proofs)
const deposits = await client.query()
  .activities()
  .byType('DEPOSIT')
  .byPaymaster('0x4DACA5b0a5d10853F84bB400C5232E4605bc14A0')
  .orderByTimestamp('asc')
  .execute()

const commitments = deposits.map(d => d.commitment)
```

## Next Steps

- **[Query API Reference](/data/queries)** - Complete query builder methods
- **[Integration Guide](/guides/integration)** - Using with React/Next.js