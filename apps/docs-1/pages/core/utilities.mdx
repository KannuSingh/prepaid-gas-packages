# Utilities

Helper functions and validation utilities for working with paymaster data and context encoding.

## Context Encoding

### encodePaymasterContext()

Encode paymaster context for 480-byte paymaster data format:

```typescript
function encodePaymasterContext(
  paymasterAddress: Address,
  poolId: bigint,
  identity: Hex
): Hex
```

**Parameters:**
- `paymasterAddress` - Paymaster contract address
- `poolId` - Pool identifier as bigint
- `identity` - Identity data as hex string

**Returns:** Encoded context as hex string

**Example:**
```typescript
import { encodePaymasterContext } from '@prepaid-gas/core'

const context = encodePaymasterContext(
  '0x1234567890123456789012345678901234567890',
  123n,
  '0xabcdef...'
)

console.log('Encoded context:', context)
```

### parsePaymasterContext()

Parse paymaster context from encoded data:

```typescript
function parsePaymasterContext(context: Hex): {
  paymasterAddress: Address
  poolId: bigint
  identityHex: Hex
}
```

**Parameters:**
- `context` - Encoded context as hex string

**Returns:** Parsed context components

**Example:**
```typescript
import { parsePaymasterContext } from '@prepaid-gas/core'

const parsed = parsePaymasterContext(encodedContext)
console.log('Paymaster:', parsed.paymasterAddress)
console.log('Pool ID:', parsed.poolId.toString())
console.log('Identity:', parsed.identityHex)
```

## Data Generation

### generatePaymasterData()

Generate complete 480-byte paymaster data with ZK proof:

```typescript
function generatePaymasterData(
  config: bigint,
  poolId: bigint,
  proof: SemaphoreProof
): Hex
```

**Parameters:**
- `config` - Configuration bits (merkleRootIndex + mode + reserved)
- `poolId` - Pool identifier
- `proof` - Generated Semaphore ZK proof

**Returns:** Complete 480-byte paymaster data

**Example:**
```typescript
import { generatePaymasterData, encodeConfig } from '@prepaid-gas/core'

const config = encodeConfig({
  merkleRootIndex: 5,
  mode: 0, // VALIDATION_MODE
})

const paymasterData = generatePaymasterData(
  config,
  123n,
  semaphoreProof
)

console.log('Paymaster data length:', paymasterData.length) // 0x + 960 chars = 482 chars total
```

### encodeConfig()

Encode configuration bits for paymaster data:

```typescript
function encodeConfig(params: {
  merkleRootIndex: number
  mode: number
}): bigint
```

**Parameters:**
- `merkleRootIndex` - Merkle root index (0-63)
- `mode` - Operation mode (0 = validation, 1 = estimation)

**Returns:** Encoded configuration as bigint

**Example:**
```typescript
import { encodeConfig } from '@prepaid-gas/core'

// Validation mode with recent Merkle root
const config = encodeConfig({
  merkleRootIndex: 0, // Latest root
  mode: 0, // VALIDATION_MODE
})

// Estimation mode (dummy data)
const estimationConfig = encodeConfig({
  merkleRootIndex: 0,
  mode: 1, // GAS_ESTIMATION_MODE
})
```

## Validation Functions

### validatePoolId()

Validate pool ID is within safe integer range:

```typescript
function validatePoolId(poolId: string): void
```

**Parameters:**
- `poolId` - Pool ID as string

**Throws:** `ValidationError` if invalid

**Example:**
```typescript
import { validatePoolId, ValidationError } from '@prepaid-gas/core'

try {
  validatePoolId('123') // ✅ Valid
  validatePoolId('999999999999999999999') // ❌ Too large
} catch (error) {
  if (error instanceof ValidationError) {
    console.error('Invalid pool ID:', error.message)
  }
}
```

### validateMerkleRootIndex()

Validate Merkle root index is within valid range:

```typescript
function validateMerkleRootIndex(index: number): void
```

**Parameters:**
- `index` - Merkle root index (must be 0-63)

**Throws:** `ValidationError` if out of range

**Example:**
```typescript
import { validateMerkleRootIndex } from '@prepaid-gas/core'

validateMerkleRootIndex(0)  // ✅ Valid
validateMerkleRootIndex(63) // ✅ Valid
validateMerkleRootIndex(64) // ❌ Throws error
```

## Network Utilities

### getChainById()

Get network configuration by chain ID:

```typescript
function getChainById(chainId: number): NetworkConfig | undefined
```

**Parameters:**
- `chainId` - Network chain ID

**Returns:** Network configuration or undefined

**Example:**
```typescript
import { getChainById } from '@prepaid-gas/core'

const network = getChainById(84532)
if (network) {
  console.log('Network name:', network.name)
  console.log('Paymaster address:', network.paymasterAddress)
  console.log('Subgraph URL:', network.subgraphUrl)
}
```

### validatePaymasterAndData()

Validate paymaster address and data format:

```typescript
function validatePaymasterAndData(
  paymaster: Address,
  paymasterData: Hex
): void
```

**Parameters:**
- `paymaster` - Paymaster contract address
- `paymasterData` - Paymaster data (must be exactly 480 bytes)

**Throws:** `ValidationError` if invalid

**Example:**
```typescript
import { validatePaymasterAndData } from '@prepaid-gas/core'

try {
  validatePaymasterAndData(
    '0x1234567890123456789012345678901234567890',
    '0x' + '00'.repeat(480) // 480 bytes of data
  )
  console.log('Valid paymaster data')
} catch (error) {
  console.error('Invalid paymaster data:', error.message)
}
```

## Legacy Compatibility

### Legacy Function Exports

The package maintains compatibility with previous workspace versions:

```typescript
// All original functions are re-exported
import {
  // Legacy encoding functions
  encodeContext,
  generatePaymasterData,
  encodeConfig,
  
  // Legacy validation functions
  validatePaymasterAndData,
  getChainById,
  
  // Legacy ABI exports
  GAS_LIMITED_PAYMASTER_ABI,
  ONE_TIME_USE_PAYMASTER_ABI,
} from '@prepaid-gas/core'
```

## Constants

### Operation Modes

```typescript
export const VALIDATION_MODE = 0     // Real ZK proof validation
export const GAS_ESTIMATION_MODE = 1 // Dummy data for estimation
```

### Data Sizes

```typescript
export const PAYMASTER_DATA_SIZE = 480  // bytes
export const CONFIG_SIZE = 32           // bytes  
export const POOL_ID_SIZE = 32          // bytes
export const PROOF_SIZE = 416           // bytes
```

### Pool Configuration

```typescript
export const POOL_ROOT_HISTORY_SIZE = 64    // Maximum Merkle root history
export const POST_OP_GAS_LIMIT = 100000n    // Gas limit for post-operation
```

## Error Types

### ValidationError

Thrown for input validation failures:

```typescript
class ValidationError extends Error {
  field: string
  value: unknown
  
  constructor(field: string, message: string, value?: unknown)
}
```

### PaymasterError

Thrown for paymaster operation failures:

```typescript
class PaymasterError extends Error {
  code: string
  context?: Record<string, unknown>
  
  constructor(code: string, message: string, context?: Record<string, unknown>)
}
```

## Type Definitions

### Core Types

```typescript
// Network configuration
interface NetworkConfig {
  chainId: number
  name: string
  paymasterAddress: Address
  subgraphUrl: string
  rpcUrl?: string
}

// Paymaster operation result
interface PaymasterResult {
  paymaster: Address
  paymasterData: Hex
  paymasterVerificationGasLimit: bigint
  paymasterPostOpGasLimit: bigint
  callGasLimit: bigint
  verificationGasLimit: bigint
  preVerificationGas: bigint
  isFinal: boolean
}

// Configuration parameters
interface ConfigParams {
  merkleRootIndex: number
  mode: number
}
```

## Best Practices

### Input Validation

Always validate inputs before processing:

```typescript
import { validatePoolId, validateMerkleRootIndex } from '@prepaid-gas/core'

function processPoolOperation(poolId: string, rootIndex: number) {
  // Validate inputs first
  validatePoolId(poolId)
  validateMerkleRootIndex(rootIndex)
  
  // Proceed with operation
  // ...
}
```

### Error Handling

Use specific error types for proper error handling:

```typescript
import { ValidationError, PaymasterError } from '@prepaid-gas/core'

try {
  await somePaymasterOperation()
} catch (error) {
  if (error instanceof ValidationError) {
    // Handle validation errors
    console.error(`Invalid ${error.field}: ${error.message}`)
  } else if (error instanceof PaymasterError) {
    // Handle paymaster errors
    console.error(`Paymaster error ${error.code}: ${error.message}`)
  } else {
    // Handle other errors
    console.error('Unexpected error:', error)
  }
}
```

### Data Size Validation

Ensure paymaster data is exactly the expected size:

```typescript
import { PAYMASTER_DATA_SIZE } from '@prepaid-gas/core'

function checkPaymasterData(data: Hex) {
  const expectedBytes = PAYMASTER_DATA_SIZE
  const actualBytes = (data.length - 2) / 2 // Remove 0x prefix and convert to bytes
  
  if (actualBytes !== expectedBytes) {
    throw new Error(`Expected ${expectedBytes} bytes, got ${actualBytes}`)
  }
}
```