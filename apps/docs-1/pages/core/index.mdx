# Core Package Overview

The `@prepaid-gas/core` package is the main SDK for privacy-preserving gas payments. It provides the `PrepaidGasPaymaster` client for generating zero-knowledge proofs and managing paymaster interactions.

## Key Features

- **Two-Phase Operations**: Separate estimation and validation phases for optimal UX
- **Zero-Knowledge Proofs**: Semaphore protocol integration for privacy
- **Network Support**: Multi-chain configuration with automatic contract discovery  
- **Type Safety**: Comprehensive TypeScript types and validation
- **Context Encoding**: Standardized 480-byte paymaster data format

## Installation

```bash
npm install @prepaid-gas/core
```

## Quick Start

```typescript
import { PrepaidGasPaymaster } from '@prepaid-gas/core'

// Create client for specific network
const paymaster = PrepaidGasPaymaster.createForNetwork(84532) // Base Sepolia

// Generate paymaster data with ZK proof
const result = await paymaster.getPaymasterData({
  userOp,
  poolId: '1',
  identity: 'base64-encoded-identity'
})
```

## Architecture

### Two-Phase Operation Model

The SDK uses a sophisticated two-phase approach:

**1. Gas Estimation Phase** (`GAS_ESTIMATION_MODE = 1`):
- Uses dummy proof data for fast gas estimation
- No ZK proof generation required
- Returns `isFinal: false` 

**2. Validation Phase** (`VALIDATION_MODE = 0`):
- Generates real ZK proof of pool membership  
- Full Semaphore protocol validation
- Returns final paymaster data for transaction

### Zero-Knowledge Privacy

**Pool-Based Anonymity**:
- Users join pools by adding identity commitments to Merkle trees
- Gas payments prove membership without revealing identity
- Nullifiers prevent double-spending but create linkability within pools

**Cross-Pool Privacy**:
- Same identity across pools = linkable transactions
- Different identities across pools = unlinkable transactions
- Use separate identities for maximum privacy

### Paymaster Data Format

The SDK generates exactly **480 bytes** of paymaster data:

```
┌─────────────┬─────────────┬─────────────────┐
│   config    │   poolId    │   encodedProof  │
│  (32 bytes) │ (32 bytes)  │   (416 bytes)   │
└─────────────┴─────────────┴─────────────────┘
```

- **config**: `merkleRootIndex + mode + reserved bits`
- **poolId**: Pool identifier (uint256)
- **encodedProof**: Semaphore ZK proof (5 + 8 uint256 values)

## Core Classes

### PrepaidGasPaymaster

The main client for paymaster interactions.

**Factory Methods**:
```typescript
// Automatic network configuration
const paymaster = PrepaidGasPaymaster.createForNetwork(chainId)

// Custom configuration  
const paymaster = new PrepaidGasPaymaster(options)
```

**Key Methods**:
- [`getPaymasterStubData()`](/core/client#getpaymasterstubdata) - Fast gas estimation
- [`getPaymasterData()`](/core/client#getpaymasterdata) - ZK proof generation
- [`validatePoolId()`](/core/client#validatepoolid) - Input validation

### Utility Functions

**Context Encoding**:
```typescript
import { encodePaymasterContext, parsePaymasterContext } from '@prepaid-gas/core'

// Encode context for paymaster
const context = encodePaymasterContext(paymasterAddress, poolId, identity)

// Parse context from paymaster data
const { paymasterAddress, poolId, identityHex } = parsePaymasterContext(context)
```

**Validation**:
```typescript
import { validatePoolId, validateMerkleRootIndex } from '@prepaid-gas/core'

// Validate inputs
validatePoolId(poolId) // Throws if invalid
validateMerkleRootIndex(index) // Validates 0-63 range
```

## Network Configuration

### Supported Networks

| Network | Chain ID | Status |
|---------|----------|---------|
| Base Sepolia | 84532 | ✅ Active |
| Base Mainnet | 8453 | 🔄 Coming Soon |
| Optimism Sepolia | 11155420 | 🔄 Coming Soon |

### Custom Network Setup

```typescript
import { PrepaidGasPaymaster, type PaymasterOptions } from '@prepaid-gas/core'

const options: PaymasterOptions = {
  chainId: 84532,
  paymasterAddress: '0x...',
  subgraphUrl: 'https://api.thegraph.com/subgraphs/name/...',
  rpcUrl: 'https://sepolia.base.org',
}

const paymaster = new PrepaidGasPaymaster(options)
```

## Error Handling

The SDK provides detailed error information:

```typescript
import { PaymasterError, ValidationError } from '@prepaid-gas/core'

try {
  await paymaster.getPaymasterData(params)
} catch (error) {
  if (error instanceof ValidationError) {
    console.error('Validation failed:', error.field, error.message)
  } else if (error instanceof PaymasterError) {
    console.error('Paymaster error:', error.code, error.message)
  }
}
```

## Performance Considerations

**Gas Estimation**: Always use `getPaymasterStubData()` for gas estimation - it's ~100x faster than generating real proofs.

**Proof Generation**: ZK proof generation takes 2-5 seconds. Consider:
- Showing loading states in UI
- Pre-generating proofs when possible
- Using Web Workers for non-blocking proof generation

**Caching**: The SDK automatically caches:
- Network configurations
- Subgraph client instances  
- Pool member data for proof generation

## Security Notes

**Identity Storage**: Never expose private identity data. Use secure storage:

```typescript
// ✅ Good: Secure storage
const identity = Identity.import(await secureStorage.get('identity'))

// ❌ Bad: Plain text storage  
const identity = Identity.import(localStorage.getItem('identity'))
```

**Pool Selection**: Consider privacy implications:
- Larger pools provide better anonymity
- Cross-pool transactions require different identities
- Monitor pool membership before joining

## Next Steps

- **[PrepaidGasPaymaster Client](/core/client)** - Detailed API reference
- **[Utilities](/core/utilities)** - Helper functions and validation
- **[Types](/core/types)** - TypeScript type definitions
- **[Integration Guide](/guides/integration)** - Production deployment

## Examples

- **[Basic Usage](/examples/basic)** - Simple paymaster integration
- **[Advanced Features](/examples/advanced)** - Pool management and optimization  
- **[React Integration](/examples/react)** - Frontend integration patterns