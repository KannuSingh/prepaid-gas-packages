# Troubleshooting

Common issues and solutions when working with the Prepaid Gas SDK.

## Common Errors

### ValidationError: Invalid pool ID

**Error**: `ValidationError: Pool ID must be a valid integer string`

**Cause**: Pool ID is not in the correct format

**Solution**:
```typescript
// ❌ Wrong: Using number
await paymaster.getPaymasterData({ poolId: 1, ... })

// ✅ Correct: Using string
await paymaster.getPaymasterData({ poolId: '1', ... })
```

### PaymasterError: Pool not found

**Error**: `PaymasterError: No pool found with ID: 999`

**Cause**: Pool doesn't exist or hasn't been indexed yet

**Solution**:
```typescript
// Check available pools first
const pools = await subgraphClient.query()
  .pools()
  .byNetwork('base-sepolia')
  .execute()

console.log('Available pools:', pools.map(p => p.poolId))
```

### ZK Proof Generation Failed

**Error**: `Error generating Semaphore proof`

**Cause**: Identity not found in pool membership

**Solution**:
```typescript
// Verify identity is a pool member
const members = await subgraphClient.query()
  .poolMembers()
  .byPool('1')
  .execute()

const identity = Identity.import(identityString)
const isMember = members.some(m => 
  m.identityCommitment === identity.commitment.toString()
)

if (!isember) {
  console.error('Identity not found in pool members')
}
```

## Network Issues

### Subgraph Unavailable

**Error**: `SubgraphError: Failed to fetch from subgraph`

**Diagnosis**:
```typescript
// Test subgraph connectivity
try {
  const response = await fetch(subgraphUrl, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      query: '{ _meta { block { number } } }'
    })
  })
  
  if (!response.ok) {
    console.error('Subgraph HTTP error:', response.status)
  }
} catch (error) {
  console.error('Network error:', error)
}
```

**Solutions**:
- Check network connectivity
- Verify subgraph URL is correct
- Try alternative subgraph endpoints
- Implement retry logic with exponential backoff

### RPC Errors

**Error**: `RPC request failed`

**Solution**:
```typescript
// Use fallback RPC endpoints
const rpcEndpoints = [
  'https://sepolia.base.org',
  'https://base-sepolia.public.blastapi.io',
  'https://base-sepolia.blockpi.network/v1/rpc/public'
]

async function withRpcFallback<T>(operation: (rpc: string) => Promise<T>): Promise<T> {
  for (const rpc of rpcEndpoints) {
    try {
      return await operation(rpc)
    } catch (error) {
      console.warn(`RPC ${rpc} failed:`, error.message)
    }
  }
  throw new Error('All RPC endpoints failed')
}
```

## Performance Issues

### Slow Proof Generation

**Issue**: ZK proof generation takes too long

**Solutions**:

**Use Web Workers**:
```typescript
// proof-worker.js
importScripts('/semaphore-proof.js')

self.onmessage = async function(e) {
  try {
    const proof = await generateProof(e.data)
    self.postMessage({ result: proof })
  } catch (error) {
    self.postMessage({ error: error.message })
  }
}
```

**Pre-generate Proofs**:
```typescript
// Pre-generate common proofs
const proofCache = new Map()

async function getCachedProof(params) {
  const key = JSON.stringify(params)
  
  if (!proofCache.has(key)) {
    const proof = await generateProof(params)
    proofCache.set(key, proof)
  }
  
  return proofCache.get(key)
}
```

### High Memory Usage

**Issue**: Browser memory consumption is high

**Solutions**:
- Clear proof caches periodically
- Use smaller pool member limits
- Implement data pagination
- Dispose of unused objects

```typescript
// Memory management
class ManagedCache<T> {
  private cache = new Map<string, { data: T, timestamp: number }>()
  private maxSize = 100
  private ttl = 5 * 60 * 1000 // 5 minutes
  
  set(key: string, data: T) {
    // Remove expired entries
    this.cleanup()
    
    // Remove oldest entries if cache is full
    if (this.cache.size >= this.maxSize) {
      const oldest = Array.from(this.cache.entries())
        .sort((a, b) => a[1].timestamp - b[1].timestamp)[0]
      this.cache.delete(oldest[0])
    }
    
    this.cache.set(key, { data, timestamp: Date.now() })
  }
  
  private cleanup() {
    const now = Date.now()
    for (const [key, value] of this.cache) {
      if (now - value.timestamp > this.ttl) {
        this.cache.delete(key)
      }
    }
  }
}
```

## Integration Issues

### Bundle Size Too Large

**Issue**: SDK increases bundle size significantly

**Solutions**:

**Tree Shaking**:
```typescript
// Import only what you need
import { PrepaidGasPaymaster } from '@prepaid-gas/core'
import { SubgraphClient } from '@prepaid-gas/data'

// Avoid importing everything
// import * from '@prepaid-gas/core' // ❌
```

**Dynamic Imports**:
```typescript
// Lazy load heavy components
const PaymasterClient = lazy(() => 
  import('@prepaid-gas/core').then(m => ({ default: m.PrepaidGasPaymaster }))
)
```

**Code Splitting**:
```typescript
// Split proof generation into separate chunk
const generateProof = async (params) => {
  const { generateSemaphoreProof } = await import('./proof-generator')
  return generateSemaphoreProof(params)
}
```

### TypeScript Errors

**Error**: `Module not found` or type errors

**Solutions**:

**Check TypeScript Configuration**:
```json
// tsconfig.json
{
  "compilerOptions": {
    "moduleResolution": "bundler",
    "allowSyntheticDefaultImports": true,
    "esModuleInterop": true,
    "resolveJsonModule": true
  }
}
```

**Update Package Versions**:
```bash
npm update @prepaid-gas/core @prepaid-gas/data
```

**Clear TypeScript Cache**:
```bash
rm -rf node_modules/.cache
rm tsconfig.tsbuildinfo
```

## Debugging Tools

### Debug Mode

Enable debug logging:

```typescript
const paymaster = new PrepaidGasPaymaster({
  chainId: 84532,
  paymasterAddress: '0x...',
  subgraphUrl: '...',
  debug: true // Enable debug logs
})
```

### Network Inspector

Monitor network requests:

```typescript
// Network request interceptor
const originalFetch = window.fetch
window.fetch = async (...args) => {
  console.log('Fetch request:', args)
  const response = await originalFetch(...args)
  console.log('Fetch response:', response.status, response.url)
  return response
}
```

### State Debugging

Track SDK state:

```typescript
// State debugger utility
class SDKDebugger {
  static logPaymasterState(paymaster) {
    console.group('Paymaster State')
    console.log('Chain ID:', paymaster.chainId)
    console.log('Paymaster Address:', paymaster.paymasterAddress)
    console.log('Subgraph URL:', paymaster.subgraphUrl)
    console.groupEnd()
  }
  
  static logProofGeneration(params, result) {
    console.group('Proof Generation')
    console.log('Input params:', params)
    console.log('Result:', result)
    console.log('Proof size:', result.paymasterData.length)
    console.groupEnd()
  }
}
```

## Environment-Specific Issues

### Next.js Issues

**Error**: `ReferenceError: window is not defined`

**Solution**:
```typescript
// Client-side only usage
import dynamic from 'next/dynamic'

const PaymasterComponent = dynamic(
  () => import('./PaymasterComponent'),
  { ssr: false }
)
```

### Vite Issues

**Error**: Module resolution errors

**Solution**:
```typescript
// vite.config.ts
export default defineConfig({
  optimizeDeps: {
    include: ['@prepaid-gas/core', '@prepaid-gas/data']
  },
  resolve: {
    alias: {
      '@prepaid-gas/core': '@prepaid-gas/core/dist/index.mjs'
    }
  }
})
```

### Webpack Issues

**Error**: `Can't resolve` errors

**Solution**:
```typescript
// webpack.config.js
module.exports = {
  resolve: {
    fallback: {
      "crypto": require.resolve("crypto-browserify"),
      "stream": require.resolve("stream-browserify"),
      "buffer": require.resolve("buffer")
    }
  }
}
```

## Getting Help

### Self-Diagnosis Checklist

Before seeking help:

- [ ] Check error message for specific details
- [ ] Verify network connectivity
- [ ] Confirm correct package versions
- [ ] Test with minimal reproduction case
- [ ] Check console for additional errors
- [ ] Try with different browser/environment

### Support Resources

- **GitHub Issues**: [Report bugs and issues](https://github.com/your-org/prepaid-gas-packages/issues)
- **Documentation**: Check this documentation for guides
- **Examples**: Review example applications for patterns
- **Community**: Join Discord/Telegram for community support

### Bug Report Template

When reporting issues:

```markdown
## Bug Report

**Package Version**: @prepaid-gas/core@0.0.1

**Environment**:
- Node.js: v20.x
- Browser: Chrome 120
- Framework: Next.js 14

**Error Message**:
```
[Paste full error message]
```

**Reproduction Steps**:
- Step 1
- Step 2
- Step 3

**Expected Behavior**:
[What should happen]

**Actual Behavior**:
[What actually happens]

**Additional Context**:
[Any other relevant information]
```